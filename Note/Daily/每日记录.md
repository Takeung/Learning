# 每日记录

- [每日记录](#每日记录)
  - [周报：2024.7.15~19](#周报202471519)
    - [2024.7.19](#2024719)
    - [2024.7.18](#2024718)
      - [一体机MCU电源状态监控](#一体机mcu电源状态监控)
      - [一体机上下电单控毫米波雷达](#一体机上下电单控毫米波雷达)
      - [一体机上下电单控相机](#一体机上下电单控相机)
    - [2024.7.17](#2024717)
    - [2024.7.16](#2024716)
    - [2024.7.15](#2024715)
  - [周报：2024.7.8~12](#周报20247812)
  - [周报：2024.7.1~5](#周报2024715)


## 周报：2024.7.15~19

### 2024.7.19

### 2024.7.18

#### 一体机MCU电源状态监控

目前版本中提供了

```c
tztek_ina3221_GETShuntVoltage_ALL();
tztek_ina3221_GETBusVoltage_ALL();
```

可以用来读取INA3221电源监控芯片中的原始值，乘以系数40uv即为真实电压值，可通过以下代码转换

```c
int16_t raw_value = (rx_data[0] << 8) | rx_data[1];
float shunt_voltage = raw_value * 40.0e-6; // 转换为伏特
printf("Shunt Voltage: %.6f V\n", shunt_voltage);
```

但目前该接口实现只将电压值打印，未通过UART串口输出。故而需要

1、周期（1s）上送，创建全局变量
2、转换输出并格式化
3、通过`void UART_SendData( uint8_t *data, size_t size)`将格式化信息输出到串口，供orin接收

> 实现细节可以参考温湿度的周期上报
>
> ```c
> // 没有下电请求，执行其他周期性任务
> tztek_aht2415c_GET_ALL();
> 
> // 格式化要发送的数据字符串
> char data_string[50];
> snprintf(data_string, sizeof(data_string), "RH: %0.2f %% T: %0.2f °C\r\n", g_humidity, g_temperature);
> 
> // 发送数据到串口
> UART_SendData((uint8_t*)data_string, strlen(data_string));
> ```

#### 一体机上下电单控毫米波雷达

查询[MCU porting guide](/home/tyjt/Downloads/Documents/MCU_porting guide_CYT4BF.xlsx)可以发现，毫米波12V供电使能PIN脚为MCU上P2.7

![](https://s2.loli.net/2024/07/18/WVtEJazchuj3pI7.png)

查看IAR源码了解，系统上下电过程中会主动使能、清除该引脚状态，从而控制毫米波雷达的供电

```c
// 上电置位
Cy_GPIO_Set(USER_MM12V_PORT, USER_MM12V_PIN);
// 下电清空
Cy_GPIO_Clr(USER_MM12V_PORT, USER_MM12V_PIN);

// 引脚定义
#define USER_MM12V_PORT                    USER_MM12V_PORT1

#define USER_MM12V_PORT1                    GPIO_PRT2
#define USER_MM12V_PIN1                     7
#define USER_MM12V_PIN_MUX1                 P2_7_GPIO
```

因为毫米波雷达上下电不受时序影响，由此可以定义一个控制毫米波雷达下电重启的简易函数

```c
void mm_wave_radar_power_reset(void)
{
	// 下电清空
    Cy_GPIO_Clr(USER_MM12V_PORT, USER_MM12V_PIN);
    // 等待0.1s
    Cy_SysTick_DelayInUs(100000ul);
    // 上电置位
    Cy_GPIO_Set(USER_MM12V_PORT, USER_MM12V_PIN);
}
```

该函数可以在`void processMessage(int msg)`中直接在某个case下调用处理。

#### 一体机上下电单控相机

与毫米波雷达相似，查到相机12V供电使能PIN脚为MCU上P2.6

```c
// 上电置位
Cy_GPIO_Set(USER_CAM12V_PORT, USER_CAM12V_PIN);
// 下电清空
Cy_GPIO_Clr(USER_CAM12V_PORT, USER_CAM12V_PIN);

// 引脚定义
#define USER_CAM12V_PORT                    USER_CAM12V_PORT1

#define USER_CAM12V_PORT1                    GPIO_PRT2
#define USER_CAM12V_PIN1                     6
#define USER_CAM12V_PIN_MUX1                 P2_6_GPIO
```

因为相机上下电不受时序影响，由此可以定义一个控制相机下电重启的简易函数

```c
void camera_power_reset(void)
{
	// 下电清空
	Cy_GPIO_Clr(USER_CAM12V_PORT, USER_CAM12V_PIN);
    // 等待0.1s
    Cy_SysTick_DelayInUs(100000ul);
    // 上电置位
	Cy_GPIO_Set(USER_CAM12V_PORT, USER_CAM12V_PIN);
}
```

该函数可以在`void processMessage(int msg)`中直接在某个case下调用处理。

### 2024.7.17

完成《动手学ROS》入门篇第5章关于ROS2常用工具的学习、实操和总结；

同时学习了解了ROS2硬件控制篇。

### 2024.7.16

完成《动手学ROS》入门篇第4章关于ROS2通信之参数与动作的学习、实操和总结；

经过与天准同事沟通确认，MCU通过INA3221电源监控芯片实时监控MCU供电状态，可以调用接口`tztek_ina3221_GETShuntVoltage_ALL`和`tztek_ina3221_GETBusVoltage_ALL`获取并打印各路电压。

### 2024.7.15

完成《动手学ROS》入门篇第3章关于ROS2节点通信之话题与服务的学习、实操和总结。

------

## 周报：2024.7.8~12

本周重点进展、问题及风险:

1、梳理一体机工程源码，理清了MCU从接收Orin下发的UART上下电指令到完成复位的控制逻辑，并实测验证通过；但是发现一个潜在Bug：程序在处理接收到的UART指令时，只会在顺次发送每满14个字符时做一次匹配，一旦输入顺序错乱，就很难再输对正确指令完成复位控制（该Bug可以通过脚本或者串口助手保证正确输入顺序的方式得以规避）。

2、安装ROS2开发环境，学习ROS2节点通信基础知识。

下周工作计划:

1、一体机远程监控/上下电控制功能的进一步开发。

2、继续学习ROS2。

本周工作其他细节及思考:

查漏补缺，及时总结。

------

## 周报：2024.7.1~5

本周工作内容:

1、参加入职培训，学习项目背景和企业文化；

2、学习新手教程，申请账号并搭建开发环境；

3、学习天准提供的一体机工程源码，为MCU控制任务做准备。

下周工作计划:

在继续熟悉一体机工程源码有关上下电逻辑的基础上，按时完成远程控制一体机上下电的任务计划。