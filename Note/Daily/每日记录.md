# 每日记录

- [每日记录](#每日记录)
  - [周报：2024.9.29~9.30](#周报2024929930)
    - [2024.9.30](#2024930)
      - [版本更新——R1.0\_V1.0.0.6](#版本更新r10_v1006)
      - [同步一体机A、B样历次MCU固件的版本和日志](#同步一体机ab样历次mcu固件的版本和日志)
      - [清理MCU源码中的编译告警](#清理mcu源码中的编译告警)
      - [2号路口首批安装的两台A样整机节后拆回整修](#2号路口首批安装的两台a样整机节后拆回整修)
    - [2024.9.29](#2024929)
      - [版本更新——R1.0\_V1.0.0.5](#版本更新r10_v1005)
      - [更新所有外挂设备MCU固件以尝试解决频繁切区重启的问题](#更新所有外挂设备mcu固件以尝试解决频繁切区重启的问题)
  - [周报：2024.9.23~9.27](#周报2024923927)
    - [2024.9.27](#2024927)
      - [版本更新——R2.0-MCU-V1.0.0.1](#版本更新r20-mcu-v1001)
      - [SOC自动升级MCU固件服务](#soc自动升级mcu固件服务)
    - [2024.9.26](#2024926)
      - [版本更新——R1.0\_V1.0.0.5](#版本更新r10_v1005-1)
    - [2024.9.25](#2024925)
      - [5G模块复位工具](#5g模块复位工具)
    - [2024.9.24](#2024924)
      - [增加MCU在A样和B样硬件上所用的APP及迭代历史到ROS源码分支](#增加mcu在a样和b样硬件上所用的app及迭代历史到ros源码分支)
    - [2024.9.23](#2024923)
      - [MCU概率性跑死导致版本回退重启](#mcu概率性跑死导致版本回退重启)
  - [试用期工作总结](#试用期工作总结)
    - [一、工作回顾](#一工作回顾)
    - [二、个人对本职工作思考](#二个人对本职工作思考)
    - [三、工作中存在的不足与提升方向](#三工作中存在的不足与提升方向)
  - [周报：2024.9.18~9.20](#周报2024918920)
    - [2024.9.20](#2024920)
      - [版本更新——R2.0-MCU-V1.0.0.1](#版本更新r20-mcu-v1001-1)
      - [版本更新——R1.0\_V1.0.0.5](#版本更新r10_v1005-2)
    - [2024.9.19](#2024919)
      - [版本更新——R2.0-MCU-V1.0.0.1](#版本更新r20-mcu-v1001-2)
    - [2024.9.18](#2024918)
      - [MCU业务核关闭时主核重启会挂死](#mcu业务核关闭时主核重启会挂死)
      - [MCU动态获取SOC侧IP](#mcu动态获取soc侧ip)
  - [周报：2024.9.9~9.14](#周报202499914)
    - [2024.9.14](#2024914)
      - [版本更新——R2.0-MCU-V1.0.0.0](#版本更新r20-mcu-v1000)
      - [尝试优化Xmodem\_Receive函数的传输效率和稳定性](#尝试优化xmodem_receive函数的传输效率和稳定性)
      - [UDP单播通信动态配置IP](#udp单播通信动态配置ip)
    - [2024.9.13](#2024913)
      - [尝试优化Xmodem\_Receive函数的传输效率和稳定性](#尝试优化xmodem_receive函数的传输效率和稳定性-1)
    - [2024.9.12](#2024912)
      - [SOC监听GPIO心跳信号](#soc监听gpio心跳信号)
      - [版本更新——R2.0-MCU-V1.0.0.0](#版本更新r20-mcu-v1000-1)
    - [2024.9.11](#2024911)
      - [MCU对SOC发送GPIO心跳波形](#mcu对soc发送gpio心跳波形)
      - [汇总B样MCU电源状态信息列表及编码格式](#汇总b样mcu电源状态信息列表及编码格式)
    - [2024.9.10](#2024910)
      - [MCU对SOC发送GPIO心跳波形](#mcu对soc发送gpio心跳波形-1)
    - [2024.9.9](#202499)
      - [MCU-SOC间UDP通信收发](#mcu-soc间udp通信收发)
      - [IAR自动化编译工具支持同时输出HEX和BIN文件](#iar自动化编译工具支持同时输出hex和bin文件)
  - [周报：2024.9.2~9.6](#周报20249296)
    - [2024.9.6](#202496)
      - [版本更新——R2.0-MCU-V1.0.0.0](#版本更新r20-mcu-v1000-2)
    - [2024.9.5](#202495)
      - [B样代码适配](#b样代码适配)
    - [2024.9.4](#202494)
      - [版本更新——R1.0\_V1.0.0.4](#版本更新r10_v1004)
      - [A样硬件MCU代码仓库收尾，启动B样开发](#a样硬件mcu代码仓库收尾启动b样开发)
      - [【待办】自动化编译脚本中有关OTA升级上位机程序的编译适配](#待办自动化编译脚本中有关ota升级上位机程序的编译适配)
      - [【待办】自动化编译脚本中能否配置生成HEX并自动转换得到Srec或者直接得到APP BIN](#待办自动化编译脚本中能否配置生成hex并自动转换得到srec或者直接得到app-bin)
    - [2024.9.3](#202493)
      - [IAR命令行编译](#iar命令行编译)
    - [2024.9.2](#202492)
      - [版本更新——R1.0\_V1.0.0.4](#版本更新r10_v1004-1)
      - [IAR命令行编译](#iar命令行编译-1)
  - [周报：2024.8.26~8.30](#周报2024826830)
    - [2024.8.30](#2024830)
      - [版本更新——R1.0\_V1.0.0.4](#版本更新r10_v1004-2)
      - [电源管理诊断优化](#电源管理诊断优化)
      - [OTA升级上位机程序——优化超时参数](#ota升级上位机程序优化超时参数)
      - [INA3221读写I2C效率优化](#ina3221读写i2c效率优化)
      - [OTA升级期间MCU向SOC通知升级占用状态](#ota升级期间mcu向soc通知升级占用状态)
    - [2024.8.29](#2024829)
      - [【待办】Xmodem协议传输代码优化](#待办xmodem协议传输代码优化)
      - [电源管理诊断优化](#电源管理诊断优化-1)
      - [【待办】OTA升级上位机程序](#待办ota升级上位机程序)
    - [2024.8.28](#2024828)
      - [OTA版本更新——R1.0\_V1.0.0.3](#ota版本更新r10_v1003)
      - [OTA升级上位机程序——Xmodem传输过程中概率性资源冲突导致定时器中断失效](#ota升级上位机程序xmodem传输过程中概率性资源冲突导致定时器中断失效)
    - [2024.8.27](#2024827)
      - [MCU控制SOC（Orin/NX）下电](#mcu控制socorinnx下电)
      - [OTA升级上位机程序——调参优化](#ota升级上位机程序调参优化)
    - [2024.8.26](#2024826)
      - [OTA升级上位机程序——进入OTA模式后会存在死循环](#ota升级上位机程序进入ota模式后会存在死循环)
      - [OTA升级上位机程序——增加支持选择刷写分区和只收模式](#ota升级上位机程序增加支持选择刷写分区和只收模式)
      - [OTA升级上位机程序——sleep方法可能会被信号中断导致串口重复占用引发的异常](#ota升级上位机程序sleep方法可能会被信号中断导致串口重复占用引发的异常)
      - [OTA升级上位机程序——用户控制程序退出机制](#ota升级上位机程序用户控制程序退出机制)
  - [周报：2024.8.19~8.23](#周报2024819823)
    - [2024.8.23](#2024823)
    - [2024.8.22](#2024822)
      - [OTA升级上位机程序——支持连刷和交互模式](#ota升级上位机程序支持连刷和交互模式)
    - [2024.8.21](#2024821)
      - [OTA模式下超时退出恢复机制](#ota模式下超时退出恢复机制)
      - [OTA升级上位机程序——进入OTA模式后会存在死循环](#ota升级上位机程序进入ota模式后会存在死循环-1)
    - [2024.8.20](#2024820)
      - [可交互式OTA升级上位机](#可交互式ota升级上位机)
      - [调整毫米波雷达下电到复位的等待时间](#调整毫米波雷达下电到复位的等待时间)
    - [2024.8.19](#2024819)
      - [OTA上位机程序并行收发，支持刷写和回显](#ota上位机程序并行收发支持刷写和回显)
      - [OTA模式超时恢复](#ota模式超时恢复)
  - [周报：2024.8.12~8.16](#周报2024812816)
    - [2024.8.16](#2024816)
      - [优化SOC对MCU远程OTA升级的上位机程序](#优化soc对mcu远程ota升级的上位机程序)
    - [2024.8.15](#2024815)
      - [OTA模式下超时退出机制](#ota模式下超时退出机制)
    - [2024.8.14](#2024814)
      - [缩减电源状态上报数据信息](#缩减电源状态上报数据信息)
      - [UART数据接收完成立即清空FIFO缓存](#uart数据接收完成立即清空fifo缓存)
      - [进入OTA升级模式后启动计时，超时后退出恢复业务核运行](#进入ota升级模式后启动计时超时后退出恢复业务核运行)
    - [2024.8.13](#2024813)
      - [UART数据持续稳定收发](#uart数据持续稳定收发)
      - [梳理OTA安全升级策略](#梳理ota安全升级策略)
    - [2024.8.12](#2024812)
      - [检视TZ提供的精简版代码](#检视tz提供的精简版代码)
      - [发现Bug：UART数据发一段时间后会卡乱码并停发](#发现buguart数据发一段时间后会卡乱码并停发)
  - [周报：2024.8.5~8.9](#周报20248589)
    - [2024.8.9](#202489)
      - [支持输上报版本号及运行分区信息](#支持输上报版本号及运行分区信息)
    - [2024.8.8](#202488)
      - [读取全部ADC用电状态](#读取全部adc用电状态)
    - [2024.8.7](#202487)
      - [UART单通道OTA刷写与调试log回显测试](#uart单通道ota刷写与调试log回显测试)
      - [读取全部ADC用电状态](#读取全部adc用电状态-1)
    - [2024.8.6](#202486)
      - [UART异步读取解析更改适配同步策略](#uart异步读取解析更改适配同步策略)
    - [2024.8.5](#202485)
      - [调试TZ提供的新版OTA代码](#调试tz提供的新版ota代码)
  - [周报：2024.7.29~8.2](#周报202472982)
    - [2024.8.2](#202482)
      - [针对错序的UART命令增加重排策略](#针对错序的uart命令增加重排策略)
      - [异步读取不稳定，需要更改为同步执行](#异步读取不稳定需要更改为同步执行)
    - [2024.8.1](#202481)
      - [UART接收数据后回显给SOC](#uart接收数据后回显给soc)
      - [UART接收数据的处理逻辑](#uart接收数据的处理逻辑)
    - [2024.7.31](#2024731)
    - [2024.7.30](#2024730)
      - [一体机MCU电源状态监控：初版方案开发完成](#一体机mcu电源状态监控初版方案开发完成)
      - [总结梳理IAR工程调试配置文件缺失定位记录](#总结梳理iar工程调试配置文件缺失定位记录)
    - [2024.7.29](#2024729)
  - [周报：2024.7.22~26](#周报202472226)
    - [2024.7.26](#2024726)
      - [OTA非预期问题汇总](#ota非预期问题汇总)
      - [MCU与ROS远程上下电及电源状态监控功能联调验证成功](#mcu与ros远程上下电及电源状态监控功能联调验证成功)
    - [2024.7.25](#2024725)
    - [2024.7.24](#2024724)
      - [更新已知内容](#更新已知内容)
      - [新问题与新方向](#新问题与新方向)
    - [2024.7.23](#2024723)
      - [编码](#编码)
      - [总结](#总结)
    - [2024.7.22](#2024722)
  - [周报：2024.7.15~19](#周报202471519)
    - [2024.7.19](#2024719)
      - [熟悉MCU OTA版本IAR工程源码](#熟悉mcu-ota版本iar工程源码)
      - [MCU OTA版本代码上下电功能简单测试](#mcu-ota版本代码上下电功能简单测试)
    - [2024.7.18](#2024718)
      - [一体机MCU电源状态监控](#一体机mcu电源状态监控)
      - [一体机上下电单控毫米波雷达](#一体机上下电单控毫米波雷达)
      - [一体机上下电单控相机](#一体机上下电单控相机)
    - [2024.7.17](#2024717)
    - [2024.7.16](#2024716)
    - [2024.7.15](#2024715)
  - [周报：2024.7.8~12](#周报20247812)
  - [周报：2024.7.1~5](#周报2024715)

## 周报：2024.9.29~9.30

本周重点进展、问题及风险:

1、更新升级2号路口和园区内所有外挂一体机的MCU固件以尝试解决频繁切区重启的问题，初步验证有效；

2、完成了A、B样源码中所有编译告警的清理，但需要B样整机测试修改后的影响，避免引入新问题；

3、在A、B样MCU开发分支上同步历次迭代版本和日志说明，便于后续版本维护和问题追踪。

下周工作计划:

1、2号路口首批安装的两台A样整机节后拆回整修，重新修复两台设备的MCU固件；

2、针对清理过编译告警后的A、B样MCU源码进行长稳测试。

### 2024.9.30

#### 版本更新——R1.0_V1.0.0.6

清理编译告警；更新版本号：R1.0_V1.0.0.5->R1.0_V1.0.0.6；更新相应的固件版本。

#### 同步一体机A、B样历次MCU固件的版本和日志

同步历次迭代版本和日志说明，便于后续版本维护和问题追踪。

#### 清理MCU源码中的编译告警

完成了B样源码中所有编译告警的清理，但需要B样设备测试修改后的影响，避免引入新问题。

#### 2号路口首批安装的两台A样整机节后拆回整修

### 2024.9.29

#### 版本更新——R1.0_V1.0.0.5

修改自动化构建脚本中拷贝OTA上位机程序源码而非可执行文件；增加业务核初始化后的延时计数；调整ADC和INA3221电压偏差阈值：0.025->0.05；增加强调业务核正常运行时的调试信息；调整串口函数的声明顺序。

#### 更新所有外挂设备MCU固件以尝试解决频繁切区重启的问题

尝试更新了2号路口四台A样设备（137升级后挂死，141和177升级成功，升级后未再出现频繁切区重启的问题，168因上次升级失败而不执行升级，继续运行1.0.0.4版本软件），更新了园区内两台B样设备（248、249一次性升级成功，升级后未再出现频繁切区重启的问题）。

------

## 周报：2024.9.23~9.27

本周重点进展、问题及风险:

1、开发上位机工具持续监控全部一体机设备的在线状态并记录下线时间，辅助解决MCU概率性切区重启的问题；

2、将MCU固件及升级上位机控制程序链接到ROS源码分支，便于SOC侧部署升级，初步完成SOC侧自动升级MCU固件基本功能验证；

3、完成2号路口137、141、177三台A样整机的固件更新，168升级失败（但仍能正常使用，远程上下电受影响）；

4、完成6台B样整机187、188、190、191、192、193的MCU固件部署。

下周工作计划:

1、继续排查修复MCU概率性切区重启的问题；

2、修复更新2号路口168整机固件版本；

3、扫描MCU底软代码，并清理其中的告警和风险，已完成百分之四十。

### 2024.9.27

#### 版本更新——R2.0-MCU-V1.0.0.1

更新自动化构建脚本，补充强调调试信息；纠正OTA升级程序中有关VERSION单词拼写的错误；更正所有与复位相关标志位的名称；增加MCU正常工作时调用栈打印信息，辅助问题定位；修改OTA升级上位机程序中打开刷写文件的路径方案：相对路径->绝对路径。

#### SOC自动升级MCU固件服务

初步完成SOC侧自动升级MCU固件基本功能验证。

### 2024.9.26

#### 版本更新——R1.0_V1.0.0.5

更新自动化构建脚本，补充强调调试信息；纠正OTA升级程序中有关VERSION单词拼写的错误；更正所有与复位相关标志位的名称；UART增加UART7（对5G）的串口接收处理；修改OTA升级上位机程序中打开刷写文件的路径方案：相对路径->绝对路径。

### 2024.9.25

#### 5G模块复位工具

开发A样裸板上5G模块复位工具。

### 2024.9.24

#### 增加MCU在A样和B样硬件上所用的APP及迭代历史到ROS源码分支

将MCU固件及升级上位机控制程序链接到ROS源码分支，便于SOC侧部署升级。

### 2024.9.23

#### MCU概率性跑死导致版本回退重启

在上周五同时刷写相同版本的6台B样整机上发现，除187、188之外，192和193明确出现了刷写后常态运行过程中自动触发版本回退导致切区重启，190和191由于线下调试关机无法确定是否出现类似问题；
此外，在实验室A样硬件141、177上同样发现了自动重启切区的情况；
进一步地，通过检查已安装上杆的B样设备发现，185自安装上杆后始终未重启，186最近一次重启是今天下午一点三刻；
检查已安装上杆的A样设备发现，137最近一次重启是今天下午四点钟，168近5天内未重启。

上述设备已联系询问过相关开发同事，均未执行过主动重启的动作，结合实验室B样硬件193上实际抓到的调试日志认定：MCU软件中可能出现某一模块概率性跑死导致系统版本回退重启。

针对该问题，已经开发上位机工具持续监控全部一体机设备的上下线状态并记录时间，同时在确定问题的193设备上部署了调试软件，增加了调试日志，以用于程序再次出现问题时记录下调用栈。

## 试用期工作总结

### 一、工作回顾

在过去三个月的实习期间，工作内容主要集中在**MCU开发、OTA升级调试、ROS通信联调**等领域。以下为分类概括：

1. **MCU相关开发**

   - **上下电控制**：初期学习和调试MCU控制逻辑，逐步完善远程控制一体机的上下电功能。
   - **电源管理优化**：开发并验证电源状态监控，优化数据上报格式，减少通信负载。
   - **BSP代码适配**：适配B样硬件底层代码，开发心跳报文监测和UDP通信功能。

2. **OTA升级与优化**

   - **OTA流程设计**：逐步完善MCU OTA升级功能，包括超时退出机制、Xmodem传输、并行收发等。
   - **上位机程序优化**：设计并优化OTA升级上位机程序，提高传输稳定性，支持连刷和交互模式，改善数据传输效率。
   - **Bug定位与修复**：修复OTA过程中SOC负载过高、命令错序等问题，优化UART通信和数据重排策略。

3. **ROS与通信联调**

   - **节点通信调试**：调测验证MCU与ROS服务的通信，通过UART实现电源状态上报，解决通信错误。
   - **UDP与GPIO通信**：开发和验证MCU与SOC之间的UDP通信及GPIO心跳波形输出功能。

4. **问题定位与解决**

   - **UART数据错序问题**：通过重排策略和优化接收逻辑，解决命令错序问题，保障数据稳定性。
   - **OTA升级挂死与恢复**：优化业务核与OTA模式的切换，解决长时间运行后的传输挂死问题。

5. **工具开发与调试**

   - **自动化工具开发**：完成IAR自动化编译工具的开发，支持自动输出HEX和BIN文件，简化版本管理流程。

总体来说，工作涵盖了**底层代码开发、通信协议调试、OTA升级**及**工具链优化**等多方面，解决了多个技术难题并优化了现有方案。

### 二、个人对本职工作思考

针对当前的工作内容，以下是个人在工作中的几点思考与总结：

1. **问题定位与解决能力的提升**

   在开发和调试过程中，遇到了多个技术难题，尤其是UART命令错序、OTA升级挂死以及SOC负载导致的刷写失败等问题。通过分析现象、梳理代码、结合硬件特性逐步定位问题根源，并提出解决方案。这些经历让我意识到，问题往往不会局限于表面症状，而是涉及底层逻辑或系统交互的复杂性。因此，面临复杂问题时，除了深入研究代码和硬件文档，**及时寻求团队讨论**、**分解问题逐步验证**也是非常有效的手段。

2. **系统化思维的重要性**

   从最初参与MCU上下电控制到OTA升级再到与ROS通信的联调，所有功能模块之间相互关联，无法独立看待。特别是OTA升级中，MCU与SOC通信不畅的问题，直接影响到系统整体的稳定性。这让我意识到，**每个子系统的设计和实现都要考虑整体系统的协同工作**。例如，在OTA升级时，考虑到定时器中断与UART通信之间的资源竞争，最终决定调高定时器中断优先级，以保障关键任务的稳定执行。

3. **技术积累与持续优化**

   随着工作的深入，越来越多的技术细节需要不断优化，例如Xmodem传输效率提升、INA3221的I2C读写优化等。通过持续的性能优化，不仅提高了系统的可靠性和效率，也加深了对底层代码的理解。这让我认识到，**技术开发不仅仅是完成功能实现，更需要关注性能和稳定性**。小的优化积累在系统中会产生显著的效果，这种持续优化的过程也是提升个人技术能力的重要方式。

4. **工具化与流程自动化的价值**

   在开发过程中，工具化和流程自动化显著提高了工作效率，尤其是在IAR自动化编译工具的开发中，体会到了**标准化工具链和流程优化的价值**。通过自动化编译和构建工具，不仅节省了大量人力操作，还降低了人为错误率。未来在工作中，可以考虑更多地引入自动化测试、部署工具，从而进一步优化开发流程，确保代码质量。

5. **沟通与合作**

   与天准团队的合作、反馈问题并推动其修复是工作的重要组成部分。**有效沟通**不仅限于报告问题，还需要通过清晰的技术文档、问题描述、复现步骤等让对方更好地理解问题并加快解决过程。同时，合作中发现团队的技术反馈往往带来新的思考和思路，这种良性互动提升了问题的解决效率，也拓宽了视野。

6. **前瞻性思考与设计**

   在工作过程中，不仅关注当下的功能实现，还考虑到了未来可能的技术扩展和维护。例如在电源管理诊断的设计中，采用了灵活的数据上报格式，为将来增加传感器或状态监测提供了扩展性。类似的前瞻性设计使得系统更加具有可维护性和扩展性，**提前预见潜在的需求和问题是提升系统设计质量的关键**。

结论

通过这些工作，我体会到从问题定位到优化再到工具化的系统性思考是提升技术能力的重要过程。未来将继续加强底层技术的积累，保持前瞻性思考，同时在沟通与协作中学会借助团队力量解决问题，持续提升工作效率和系统稳定性。

### 三、工作中存在的不足与提升方向

在工作过程中，我也发现了一些不足之处，结合这些经验教训，我总结了以下几点需要提升的方向：

1. **问题处理的全面性与预见性不足**

   工作中经常出现问题解决后，新的问题随之暴露的情况。例如，OTA升级中初步解决了传输挂死的问题，但在之后的调测中又发现了定时器中断与UART通信的优先级竞争问题。这表明在问题定位时，**缺乏系统全局的考虑**，往往只关注当前显露出来的故障而忽视了潜在的系统性问题。未来在处理类似问题时，应该更加**注重系统性思考**，在设计和调试过程中有意识地预见到潜在问题，从而尽可能避免问题反复出现。

   **提升方向：**
   - **提升全局视角**，在解决问题时考虑各模块之间的交互影响。
   - **加强问题预判**，在发现和解决问题时，尝试从多维度推测其他可能的隐患。

2. **技术深度和广度不足**

   工作中涉及到的技术栈较为广泛，包括MCU的底层开发、UART通信、OTA升级、ROS等多个领域。由于涉及的知识面广，我在某些领域的技术深度和细节掌握上仍有欠缺。例如，在初期处理UART命令错序问题时，虽然能通过策略性优化解决问题，但对于UART协议的底层工作机制和更深入的处理方式理解不够透彻。

   **提升方向：**
   - **技术广度与深度并进**，在广泛接触不同技术模块的同时，对关键模块（如通信协议、底层硬件驱动等）进行更加深入的学习。
   - **自我驱动学习**，在实际工作中主动学习相关领域的理论知识，深入掌握协议、硬件机制等基础内容。

3. **工作效率的提升空间**

   在多次调测过程中，手动操作和重复验证的工作量较大，耗费了不少时间，特别是OTA升级、UART通信调试等环节，反复测试对项目进度造成了影响。尽管后期开发了自动化工具来辅助构建和调测，但**在前期对工具和自动化流程的重视不够**，导致一部分开发任务冗长耗时。

   **提升方向：**
   - **更多关注开发工具链的优化**，早期引入自动化工具和调试手段，减少重复性工作，提升整体开发效率。
   - **加强测试自动化**，对项目中的调测流程进行自动化处理，提升验证效率并减少人为操作错误。

4. **技术文档的规范化与总结**

   在项目推进中，有时会遇到问题反复讨论、设计方案多次调整的情况，部分原因是技术文档不够详尽，问题复盘和经验总结不够系统。工作中虽然能够口头讨论解决方案，但文档化和系统性总结欠缺，使得后续调试和交接时增加了难度。

   **提升方向：**
   - **规范化文档输出**，在项目的每个阶段，系统化地记录问题、解决方案、验证过程，形成完整的技术档案，便于后续参考。
   - **总结复盘**，每个阶段完成后进行系统性的复盘和经验总结，确保对问题的解决过程有清晰的记录，并为未来类似问题的解决提供依据。

5. **沟通与协作的主动性不足**

   在与天准团队或其他同事合作时，存在沟通不够及时、反馈信息不够全面的现象。例如，针对OTA升级过程中遇到的问题，有时未能主动及时反馈到团队中讨论，而是尝试单独解决。尽管最后问题解决，但也浪费了不少时间，团队力量没有得到有效利用。

   **提升方向：**
   - **加强主动沟通**，遇到问题时及时与团队讨论，充分利用集体智慧，避免过度依赖个人的解决思路，减少不必要的时间浪费。
   - **多与外部团队合作**，如供应商或外部支持团队，保持良好的技术交流，确保问题能够尽快解决，避免在信息闭塞的情况下解决问题。

6. **项目管理与时间规划能力有待加强**

   在工作推进中，某些任务由于计划不够明确，导致实际进度延误。例如，OTA升级上位机程序的开发和调测任务中，时间规划不够准确，出现了部分任务的延期。部分原因是对项目整体时间进度把控不足，未能合理安排各个阶段的任务和预留足够的时间进行验证。

   **提升方向：**
   - **加强项目时间管理**，在任务分配和计划制定时更加合理地安排时间，提前预估调试和验证可能耗费的时间。
   - **灵活应对项目进展中的突发情况**，及时调整项目计划，确保项目整体进度不被个别问题拖延。

结论

   通过对当前工作中存在的不足进行反思，我认识到技术提升、效率优化、沟通协作等方面都还有很大的提升空间。未来在工作中将更加注重全局思考、技术深耕、工具化流程的引入，进一步加强文档化和团队合作，从而在技术能力和工作效率上取得更多进步。

------

## 周报：2024.9.18~9.20

本周重点进展、问题及风险:

1、设计实现MCU侧动态获取SOC侧IP的通信方案；

2、定位解决B样整机在MCU业务核关闭时主核重启会挂死的问题；

3、更新优化OTA升级上位机程序中的Xmodem_Receive函数，保障OTA升级时MCU-SOC间的建链稳定性，同时同步修改到A样软件；

4、完成6台B样整机187、188、190、191、192、193的MCU固件部署和两台A样整机141、177的固件更新。

下周工作计划:

1、扫描MCU底软代码，并清理其中的告警和风险；

2、将MCU固件及升级上位机控制程序链接到ROS源码分支，便于SOC侧部署升级。

### 2024.9.20

#### 版本更新——R2.0-MCU-V1.0.0.1

根据实际需求将正常MCU心跳波形占空比调整为2：1；观察实际ADC输出电压的偏差比例，波动范围在5%以内，故而调整偏差比例的阈值。

#### 版本更新——R1.0_V1.0.0.5

同步B样MCU固件中有关OTA升级程序的优化更新；同步自动化构建脚本的优化更新以及IAR工程项目后编译的配置；同步ADC及INA3221电压监控报警机制：绝对阈值->偏差比例阈值；更新A样软件版本：T24DG26 R1.0_V1.0.0.4->T24DG26 R1.0_V1.0.0.5。

### 2024.9.19

#### 版本更新——R2.0-MCU-V1.0.0.1

暂时移除所有通过UART8串口辅助输出OTA升级状态的打印信息；增加MCU侧动态获取SOC侧IP策略，取消对SOC固定IP方案；调整ADC对三路加热丝的电压转换系数，由于加热丝不同温度下电阻不同，没有固定的标准电压，故而不做监控；补充调整ADC和INA3221监控到电压异常时的状态打印信息；将所有涉及到补光灯和加热丝处理的语句都替换成相应的函数；在主核上电时将USER_LMPWREN_PORT清除置位，否则在主核下电重启时对该port口置位不能生效，继而造成整机挂死，拔插电源不能恢复；移除OTA升级上位机程序中有关串口初始化被注释的无用语句；调整MCU控制监控上位机程序中有关命令取值范围的语句限制；更新优化Xmodem_receive函数，延长OTA程序对升级上位机程序的建链等待时间，降低同步失败的概率；更新MCU固件版版本：T24DG26-R2.0-MCU-V1.0.0.0->T24DG26-R2.0-MCU-V1.0.0.1。

### 2024.9.18

#### MCU业务核关闭时主核重启会挂死

由于TZ提供B样代码中整机启动后未及时清理USER_LMPWREN_PORT的置位状态，导致调用tztek_power_on下电重启时为USER_LMPWREN_PORT置位不能生效，整机无法重启，重新插拔电源无效，在Orin_power_on函数中添加相应语句后问题解决。

```c
Cy_GPIO_Clr(USER_LMPWREN_PORT, USER_LMPWREN_PIN);
```

#### MCU动态获取SOC侧IP

TZ方案中对于SOC侧IP采用固定写死在MCU固件的方案，如此在每一款MCU设备生产时都需要刷写不同的IP，固件版本也各不相同，为了降低维护成本、增强设备的适配能力，设计实现动态获取SOC侧IP的方案：整机启动后，MCU并不主动发送UDP包，当SOC侧主动向MCU发送任意数据之后，MCU将记录下SOC侧的IP为服务端地址，开始向SOC回复电源状态监控数据包，并且在此后每隔10秒发送一次。

------

## 周报：2024.9.9~9.14

本周重点进展、问题及风险:

1、IAR自动化编译工具支持同时输出HEX和BIN文件，避免频繁修改IAR工程配置；

2、调测验证MCU-SOC间UDP通信收发功能，TZ版本网络配置修改未生效，报文为组播发送，修改后功能正常；

3、调测验证MCU对SOC发送GPIO心跳波形，TZ版本发送的正常波形占空比不对，修改后功能正常；同时开发命令行工具能够正确输出频率、占空比信息以确认心跳状态，以及图形化工具正确拟合波形；

4、基于python开发SOC对MCU发送uart、udp命令以及监听GPIO心跳信号的上位机程序；

5、修改补光灯和加热片的工作策略，补光灯支持远程开闭，加热片根据湿度值自动开闭。

下周工作计划:

1、优化OTA升级上位机程序中Xmodem_Receive函数的传输效率和稳定性；

2、优化OTA升级上位机程序，确保SOC能解析升级结果并自动重试，而非人力升级，需要与SOC侧联调；

3、当前MCU-SOC间UDP单播通信需要固定两端IP，为避免MCU固件版本管理混乱，考虑优化解决；

4、开发调测5G模块与MCU间的通信方案；

5、【低优先级】待解决：OTA模式主动退出时，现无法在不下电的情况下静默恢复业务核，只能重启恢复。

### 2024.9.14

#### 版本更新——R2.0-MCU-V1.0.0.0

修改补光灯的工作策略：初次上电和复位上电时长亮1秒关闭，之后可通过UART7、UART8串口已经UDP信道接收SOC的长开长闭指令；修改加热片的工作策略：只在检测到湿度超过50%之后才启动工作，暂时未添加远程控制；相应调整MCU控制监听的上位机程序。

#### 尝试优化Xmodem_Receive函数的传输效率和稳定性

在恢复162环境时发现TZ提供的OTA版本升级时稳定性很高，但家里版本升级时反而频繁失败，怀疑是修改引入的问题，正在排查修复。

#### UDP单播通信动态配置IP

当前MCU-SOC间UDP单播通信需要固定两端IP，为避免MCU固件版本管理混乱，考虑优化解决。

### 2024.9.13

#### 尝试优化Xmodem_Receive函数的传输效率和稳定性

效率提升（升级时间可以缩减到一分钟以内），但是稳定性下降，失败率增高。

### 2024.9.12

#### SOC监听GPIO心跳信号

正确记录并图形化输出捕获到的GPIO心跳信号，修正波形频率和占空比，确保符合设计预期。

#### 版本更新——R2.0-MCU-V1.0.0.0

修改ADC状态检查时对SOC1_VDD_1V2_ADC和ETH_VDD_2V5_ADC参考值的设定错误；修改ADC和INA3221模块检查阈值的比较策略：绝对值->偏差比例，同时修改一般偏差比例阈值为2.5%，严重偏差比例阈值为5%；增加ADC和INA3221模块计算各路压流之前复位全局标志，解决“一旦状态出现异常后不能恢复正确显示”的问题；修正对SOC发送GPIO常态心跳的周期和占空比；移除构建脚本中不必要的文件删除处理；基于python开发SOC对MCU发送uart、udp命令以及监听GPIO心跳信号并计算频率和占空比的上位机程序。

### 2024.9.11

#### MCU对SOC发送GPIO心跳波形

运用Python图形化界面顺利输出心跳波形，能够自动化计算出波形频率，但是计算得到的占空比值不符合预期，仍在调试中。

#### 汇总B样MCU电源状态信息列表及编码格式

### 2024.9.10

#### MCU对SOC发送GPIO心跳波形

心跳波形初步验证正确，但未能正确图形化显示，且暂时需要人工统计触发频率。

### 2024.9.9

#### MCU-SOC间UDP通信收发

调测发现MCU有关IP地址和端口的配置实际未生效，导致电源状态数据被组播发送、SOC虽能接收但是无法向MCU主动发起通信。更新源码后验证通信稳定，MCU能够接收并识别SOC发送的UDP命令，进而执行上下电等处理。

#### IAR自动化编译工具支持同时输出HEX和BIN文件

自动化编译工具依赖于正确输出BIN文件，而调试烧录需要使用HEX格式的应用文件，所以为了兼顾两方需求而避免频繁修改IAR工程配置，所以增加编译后处理程序，能够将正确编译得到的输出文件转换为所需的两种格式。

------

## 周报：2024.9.2~9.6

本周重点进展、问题及风险:

1、完成IAR自动化构建工具的开发，便于MCU软件版本的管道更新；

2、完成MCU关于B样硬件的底层代码更新和适配，关于新增的心跳报文监测和UDP通信尚待进一步调测验证；

3、待解决：业务核长时间运行后进入OTA模式刷写CM7_0核，必现Xmodem传输挂死，重启后可解决；

4、待解决：OTA模式主动退出时，现无法在不下电的情况下静默恢复业务核，只能重启恢复。

下周工作计划:

1、优化OTA升级上位机程序，确保SOC能解析升级结果并自动重试，而非人力升级，需要与SOC侧联调；

2、基于B样硬件进一步调测验证心跳报文监测和UDP通信的业务功能；

3、优化自动化构建工具。

### 2024.9.6

#### 版本更新——R2.0-MCU-V1.0.0.0

MCU关于B样硬件的底层代码更新和适配：新增3路lm75bdp温度传感器监测，新增支持MCU对SOC三种心跳波形发送（正常、失常、警报），新增以太链路支持UDP报文收发，新增1路UART信道用于MCU-SOC间串口通信（共2路），新增高温LED闪烁报警；调整17路ADC为13路，调整9路INA3221为5路，调整整机供电涉及到的若干端口配置，更新软件版本号为T24DG26-R2.0-MCU-V1.0.0.0。

### 2024.9.5

#### B样代码适配

适配中，基本适配优化完成。

### 2024.9.4

#### 版本更新——R1.0_V1.0.0.4

添加使用IAR编译工具链的自动化构建工具；移除不必要的APP BIN文件和不再继续使用的转换脚本：generateA_app_bin_CYT2B7.bat和srec_cat.exe；调整毫米波雷达下电后延时：3s -> 9s；修改周期上送给SOC的数据包计数为10s主循环的周期运行计数，用于统计业务启动后运行时间。

#### A样硬件MCU代码仓库收尾，启动B样开发

基于IAR编译工具链的自动化构建工具开发完备，A样代码中止新的特性开发，进入B样开发阶段。目前A样尚遗留两个问题待解决：

**问题一：**OTA模式主动退出时，现无法在不下电的情况下静默恢复业务核，只能重启恢复；

**问题二：**业务核长时间运行后进入OTA模式刷写CM7_0核，必现Xmodem传输挂死，重启后可解决。

#### 【待办】自动化编译脚本中有关OTA升级上位机程序的编译适配

#### 【待办】自动化编译脚本中能否配置生成HEX并自动转换得到Srec或者直接得到APP BIN

### 2024.9.3

#### IAR命令行编译

找到缺失配置，完成自动化编译脚本开发，初步验证成功。

### 2024.9.2

#### 版本更新——R1.0_V1.0.0.4

调整超时重启策略：每次单核升级记录启动时间，当启动后计时达到60秒则认为当前刷写任务发生了阻塞，即执行重启复位。

#### IAR命令行编译

编译失败，排查缺失配置。

------

## 周报：2024.8.26~8.30

本周及上周重点进展、问题及风险:

1、OTA上位机程序并行收发，支持刷写和回显，功能稳定，能够异步接收调试日志，在执行刷写操作时关闭异步读取的子程序，保证刷写任务不被打断；

2、OTA升级上位机程序增加支持只收、连刷和交互模式，待刷写分区可通过参数指定；

3、调整毫米波雷达下电到复位的等待时间：100ms -> 3s，确保雷达完全下电后再重启，修改后雷达从下电到恢复通信的时间为10秒；

4、MCU控制SOC（Orin/NX）下电：在MCU正常工作的情况下实现SOC的下电复位；

5、OTA模式下维护两套超时退出机制：a）进入OTA模式后120秒，计时器中断更新状态标志，通知OTA主函数正常退出；b）进入OTA模式后128秒，计时器中断主动断电重启，强制恢复程序运行；

6、调高CM0核定时器中断优先级，保证高于Xmodem传输所用的UART中断优先级，确保通信出现资源竞争时定时器中断能够稳定触发，保障超时重启机制正确运行；

7、电源管理诊断优化：将原本电源状态通过浮点数值记录上报的策略修改为十六进制多字节编码的传输方案，降低UART串口传输负载，提升通信效率，涉及模块包括温度、湿度、INA3221以及ADC模块，目前已完成MCU侧代码开发并验证通过，待与SOC侧联调；

8、INA3221读写I2C效率优化：调测发现INA3221读写寄存器耗时较高，通过缩短TZ实现中较长的Cy_SysTick_DelayInUs，能够显著降低耗时，此外通过批量读取和转换电压电流，减少了函数调用的开销和代码冗余。

下周工作计划:

1、优化OTA升级上位机程序，确保SOC能解析升级结果并自动重试，而非人力升级，需要与SOC侧联调；

2、电源管理诊断优化：MCU侧开发验证完成，待与SOC侧联调验证；

3、Xmodem协议传输代码优化：检查TZ实现的Xmodem模块源码发现运行资源占用较高，可尝试优化；

4、OTA升级期间MCU向SOC通知升级占用状态：调测发现会影响Xmodem协议数据传输进而导致刷写失败（因为定时器中断优先级比UART中断优先级更高，而且Xmodem传输时会同时用到收和发），所以目前在A样硬件下并不能支持升级期间的状态上报，只能在B样版本中增加MCU-SOC间UART串口资源或者以太通路后才可实现；

5、【低优先级】OTA模式下超时退出恢复机制，仍然需要调测后与英飞凌官方沟通解决。

### 2024.8.30

#### 版本更新——R1.0_V1.0.0.4

降低OTA模式下超时退出的时限：200s->120s，同时降低超时重启的时限：240s->128s；将原本电源状态通过浮点数值记录上报的策略修改为十六进制多字节编码的传输方案，降低UART串口传输负载，提升通信效率，涉及模块包括温度、湿度、INA3221以及ADC模块；降低了INA3221在I2C读写后的等待时延：50ms->10ms，提升运行效率；由于INA3221获取的电压电流合并传输，故而移除了tztek_ina3221_GETBusVoltage_ALL和tztek_ina3221_GETShuntVoltage_ALL方法，以及相应的浮点数组g_bus_voltage_all和g_shunt_current_all，取而代之的是ina3221_get_voltage_current_aLL和g_voltage_current_all；由于电源状态上报策略变更，相应的周期传输格式也做了调整，涉及修改user_timer.c；移除了OTA升级上位机程序中receive_file和process_app_file两个方法，异步IO初始化后默认关闭使能，唯独在只收模式下打开异步IO通信使能；更新版本号：T24DG26 R1.0_V1.0.0.3 -> T24DG26 R1.0_V1.0.0.4。

#### 电源管理诊断优化

完成MCU侧代码开发并验证通过，待与SOC侧联调。

#### OTA升级上位机程序——优化超时参数

将超时退出时限设置为120秒，超时重启时限设置为128秒，提升刷写重试效率。

#### INA3221读写I2C效率优化

调测发现INA3221读写寄存器耗时较高，通过缩短TZ实现中较长的Cy_SysTick_DelayInUs，能够显著降低耗时，此外通过批量读取和转换电压电流，减少了函数调用的开销和代码冗余。

#### OTA升级期间MCU向SOC通知升级占用状态

尝试在OTA升级过程中通过串口向SOC周期上报占用状态，调测发现会影响Xmodem协议数据传输进而导致刷写失败（因为定时器中断优先级比UART中断优先级更高，而且Xmodem传输时会同时用到收和发），所以目前在A样硬件下并不能支持升级期间的状态上报，只能在B样版本中增加MCU-SOC间UART串口资源或者以太通路之后才可实现。

### 2024.8.29

#### 【待办】Xmodem协议传输代码优化

检查源码发现源码中资源占用较高，可酌情优化。

#### 电源管理诊断优化

电源管理的数据回传采用编码式，以第一路路电源为例：比如1个字节表示电源状态、第2-3字节表示电压幅值、4-5字节表示电流幅值（如有）；举例如下： 00001 xxxx  0001 0010 0101 0010 0010 0101 0010 0010 第1路 状态   1   2 .  5    2V  -  2   5.   2    2 A

目前代码已开发适配完成，顺利编译，待上板调试。

#### 【待办】OTA升级上位机程序

需要SOC能解析升级结果，可自动重试，而非人力去升级，需要与SOC侧联调。

### 2024.8.28

#### OTA版本更新——R1.0_V1.0.0.3

移除和调整了OTA过程中部分输出给SOC的log；调整了Xmodem协议等待接收UART传输APP的时间：16s->10s；补充了启用和完成Xmodem接收以及指令回显的log；调整了OTA超时退出的时间300s->200s；增加了OTA超时重启机制：当OTA程序因串口冲突引起Xmodem传输时死锁，进而导致程序挂死，超时退出并不能正确触发，需要定时器中断直接重启；对应OTA升级上位机程序增加退出指令的接收处理；调整OTA状态位的轮询时间：10s->5s；整合Orin/NX单控下电和上电：在MCU正常工作的情况下实现SOC的下电复位；OTA升级上位机程序新增支持只收、连刷和交互三种升级模式；OTA升级上位机程序新增支持参数指定预刷写分区；OTA升级上位机程序支持捕获SIGINT信号以强制退出；OTA升级上位机程序参数优化。

#### OTA升级上位机程序——Xmodem传输过程中概率性资源冲突导致定时器中断失效

排查方法如下：

1. **中断被屏蔽或优先级较低**

- **原因**: 在某些情况下，Xmodem 传输过程中可能会关闭或屏蔽其他中断，导致定时器中断无法触发。特别是如果 Xmodem 传输优先级较高，可能会导致定时器中断被延迟或忽略。
- **解决方法**: 检查是否有代码部分关闭或屏蔽了中断，确保定时器中断的优先级足够高，或者在 Xmodem 传输期间没有关闭中断。

```
c复制代码__disable_irq(); // 屏蔽中断
// Xmodem 传输代码
__enable_irq();  // 重新启用中断
```

如果有类似的代码，请确认它们不会长时间屏蔽中断。

2. **中断处理时间过长**

- **原因**: 如果 Xmodem 传输过程中占用了大量的处理时间，可能会导致定时器中断被延迟或无法及时处理，尤其是在中断优先级不高的情况下。
- **解决方法**: 确保中断处理程序简洁高效，避免在中断处理程序中执行耗时操作。你可以将复杂的处理放到主循环中，或者设置较高优先级的中断。

3. **CPU资源争用**

- **原因**: Xmodem 传输可能会占用大量 CPU 资源，特别是在数据传输密集的情况下，导致定时器中断无法及时得到处理。
- **解决方法**: 通过降低 Xmodem 传输的 CPU 使用率，或者在 Xmodem 接收期间确保 CPU 仍能处理其他中断。你可以检查传输代码，确保它不会过度占用 CPU。

4. **中断冲突或优先级倒置**

- **原因**: 如果 Xmodem 使用的外设（例如串口）与定时器中断有冲突，可能会导致中断响应异常。此外，优先级倒置（低优先级中断长时间阻塞高优先级中断）也可能导致类似问题。
- **解决方法**: 检查中断配置，确保定时器和 Xmodem 中断之间没有冲突，且优先级配置合理。

5. **定时器配置问题**

- **原因**: 定时器配置可能存在问题，导致中断在某些情况下不触发。
- **解决方法**: 确认定时器在 Xmodem 传输过程中没有被意外禁用或重置。检查相关寄存器的配置是否正确，确保定时器配置在整个传输过程中保持有效。

6. **硬件资源问题**

- **原因**: 在某些情况下，硬件资源（如 DMA、内存）可能被 Xmodem 占用，导致定时器中断不能正常工作。
- **解决方法**: 确保 Xmodem 使用的硬件资源不会与定时器中断发生冲突。例如，如果使用了 DMA，确认 DMA 不会影响定时器中断。

结合实际代码考虑，最可能是中断优先级倒置和CPU资源争用导致的问题，所以将定时器中断的优先级调为最高（1），Xmodem传输的优先级设为较低（3），也即是UART中断的优先级。验证发现，当冲突发生时，该修改方案能够保证定时器中断继续正常工作，从而保障了OTA超时退出机制的稳定运行，避免因资源冲突而无法下电恢复的问题。
调高CM0核定时器中断优先级，保证高于Xmodem传输所用的UART中断优先级，确保通信出现资源竞争时定时器中断能够稳定触发，保障超时重启机制正确运行。

### 2024.8.27

#### MCU控制SOC（Orin/NX）下电

MCU控制SOC下电后紧随上电动作，中间加上延时保证SOC完全下电。

#### OTA升级上位机程序——调参优化

连续刷写时概率性在刷写完CM7_0之后停刷，卡在delay_s(1)的位置，可以补刷（交互式刷CM7_1）通过。基本上只在刷写全新APP的时候才会出现。（刷写双区都为A代码，待排查）

### 2024.8.26

#### OTA升级上位机程序——进入OTA模式后会存在死循环

原因在于OTA刷写函数一旦运行进入死循环，计时器中断处理函数并未直接执行重启，而只是给状态标志置为1，此时将永远不能主动重启，修复实现即可。
更新了两套超时退出机制：1、超时5分钟时，计时器中断更新状态标志，通知OTA主函数正常退出；2、超时7分钟时，计时器中断主动执行断电重启动作，强制恢复程序运行。
前者表征的场景是：OTA升级过程中用户长时间未处理，OTA程序正常运行；
后者表征的场景是：OTA升级主程序挂死，用户正常操作。

#### OTA升级上位机程序——增加支持选择刷写分区和只收模式

只收模式：在除可执行文件之外不附加其他任何参数时，进入只收模式，程序可以只作为串口助手，只显示收到的log。

支持参数指定刷写分区，使用时可以先通过只收模式查看log确认当前运行分区，以“运行分区下刷写对区”的原则，可指定参数作为刷写分区，不必在各个分区APP的路径下分别维护上位机程序。

#### OTA升级上位机程序——sleep方法可能会被信号中断导致串口重复占用引发的异常

基于nanosleep替换sleep，可以将被中断时剩余的时间继续保持延时

#### OTA升级上位机程序——用户控制程序退出机制

程序存在多个while(1)的死循环，为方便用户控制命令行程序退出，增加信号处理函数。

------

## 周报：2024.8.19~8.23

本周重点进展、问题及风险:

1、OTA上位机程序并行收发，支持刷写和回显，功能调通，异步接收调试日志，在执行刷写操作时关闭异步读取的子程序，保证刷写任务不被打断；

2、OTA升级上位机程序支持连刷和交互模式；

3、调整毫米波雷达下电到复位的等待时间：100ms -> 3s，确保雷达完全下电后再重启，修改后雷达从下电到恢复通信的时间为10秒。

下周工作计划:

1、继续调测优化OTA升级的上位机程序，以求提高升级效率和刷写稳定性；

2、OTA模式下超时退出恢复机制，仍然需要调测后与英飞凌官方沟通解决；

3、尝试对现有工程做freertos的移植适配，初期将以源码优化开始着手。

### 2024.8.23

请假

### 2024.8.22

#### OTA升级上位机程序——支持连刷和交互模式

连刷模式：整机单个分区连续刷写三个核心并切换分区；

交互模式：进入上位机程序后，弹出菜单可选择进入OTA模式（0），刷写核心（1/2/3），切换分区（4），退出OTA模式。

### 2024.8.21

#### OTA模式下超时退出恢复机制

通过与英飞凌官方沟通，得知需要先将业务核切入DeepSleep模式，而后由主核确认业务核休眠状态，进一步关闭业务核的使能，再之后可以通过使能函数重新恢复业务核的主循环任务。
尝试修改源码之后，并不能达成预期，当前仍在沟通中。

#### OTA升级上位机程序——进入OTA模式后会存在死循环

需要定位解决。

### 2024.8.20

#### 可交互式OTA升级上位机

功能调通，异步接收调试日志，在执行刷写操作时关闭异步读取的子程序，保证刷写任务不被打断。

待优化思路：进入OTA模式的标志不够明晰，需要调试设置；执行过程中等待时间可以优化参数，在不影响正常功能的前提下降低等待时间。

![](https://s2.loli.net/2024/08/20/ehNClH2mSVobxIj.png)

#### 调整毫米波雷达下电到复位的等待时间

延长雷达下电到复位的等待时间：100ms -> 3s，确保雷达完全下电后再重启，修改后雷达从下电到恢复通信的时间为10秒。

### 2024.8.19

#### OTA上位机程序并行收发，支持刷写和回显

OTA上位机能够正常接收数据，但是进入刷写模式后即会不能顺利刷写成功，需要进一步测试，怀疑是接收影响了发送子程序。

#### OTA模式超时恢复

根据TZ提供的方案：先进入休眠模式再Disable，但实测并不能正常恢复。

------

## 周报：2024.8.12~8.16

本周重点进展、问题及风险:

1、检视TZ提供的精简版代码，发现精简的方式是删除构建产生的中间产物，已确认仓库创建时就是精简版本；

2、发现Bug：UART数据发一段时间后会卡乱码并停发，定位发现是TZ实现的发送函数出现了中断重入所致，通过更改发送策略已解决；

3、梳理了OTA安全升级策略，并发起会议讨论了如何保证稳定可靠的升级，收获了当前OTA升级方案中可待优化的方向：包括1）缩减电源状态上报数据信息，降低UART通信负载；2）UART数据接收完成后立即清空FIFO缓存，取代重排策略，保证UART数据稳定正确接收；

4、设计开发OTA模式下的超时退出机制：在OTA模式下超出预定时限后应当恢复业务核继续运行，保证MCU的正常工作。

5、优化SOC对MCU远程OTA升级的上位机程序，设计模块包括刷写子程序和监听子程序，目前已实现并验证了监听子程序的功能；刷写子程序开发完毕，但是验证结果未达预期， 需要继续调测。

下周工作计划:

1、当前版本的OTA模式下超时退出机制存在瑕疵：退出实际上是执行重启，原因在于重新使能业务核并不能启动业务进程，还待英飞凌官方回复解决方案；

2、继续调测优化OTA升级的上位机程序，以求提高升级效率和刷写稳定性；

3、针对TZ即将提供MCU支持GPIO心跳的工程源码，识别更新并验证功能；

4、尝试对现有工程做freertos的移植适配，初期将以源码优化开始着手。

### 2024.8.16

#### 优化SOC对MCU远程OTA升级的上位机程序

当前TZ提供的OTA升级脚本不支持升级结果回显，需要使用者频繁介入，而且额外开启回显会导致串口被重复占用，引起数据失真和刷写失败等问题，故而考虑优化上位机程序。
设计模块包括刷写子程序和监听子程序，目前已实现并验证了监听子程序的功能；刷写子程序开发完毕，但是验证结果未达预期， 需要继续调测。
1）上位机启动后会持续接收来自MCU发送的状态监控数据，并在首次启动时提示是否进入OTA模式，用户输入“yes”即可进入OTA模式；输入“no”，则退出刷写子程序，而只保留监控数据接收的子程序。
2）进入OTA模式后，状态监控数据停发，升级程序会将接收到的调试log打印在命令行，之后程序会提示用户是否开始刷写CM0，用户输入“yes”后程序会开始刷写CM0核，相应的刷写结果会在命令行上显示；假如刷写失败，程序会提示用户是否重试，直到当前核心刷写成功，之后，程序才会进入下一个核心的刷写任务。
3）如此持续，直到将CM7_0和CM7_1核也都刷写完成。
4）刷写子程序运行到最后，程序会提示用户是否切换分区，用户输入“yes”则自动切换分区，输入“no”则保留在该分区，整机会在达到超时时间之后重启。

### 2024.8.15

#### OTA模式下超时退出机制

在正确应用定时器中断的前提下，反复调试发现**定时器配置中的周期未能按照预期正确更新**，而且多次调试的结果没有规律可循，无奈之下，测试出默认配置为1秒触发周期的情况下，尝试通过读秒计数的方式获得需要的时间，开发验证后成功。
但仍有一个问题，退出OTA模式之后，并**不能通过只是调用Cy_SysEnableApplCore的方法使能业务核并启动业务程序运行**，无奈之下，只能在退出OTA模式之后调用下电复位的方法，重启退出。该问题也反馈给TZ，TZ已反馈给英飞凌官方看是否有可行的解决方法。

给137和141两块整机更新升级了最新的MCU版本。

### 2024.8.14

#### 缩减电源状态上报数据信息

包计数和版本分区信息不再标注说明，其他信息只保留一位字母缩写，如有电压则保留电压

```c
SOC_Printf("??\r\n%u\r\n", ++g_trans_packet_cnt);
SOC_Printf("%s\r\n", CURRENT_VERSION_PARTITION);
SOC_Printf("H: %0.2f %%\r\n", g_humidity);
SOC_Printf("T: %0.2f °C\r\n", g_temperature);
SOC_Printf("O12: %0.2f A, %0.2f V\r\n", g_shunt_current_all[0][0], g_bus_voltage_all[0][0]);
SOC_Printf("O5: %0.2f A, %0.2f V\r\n", g_shunt_current_all[0][1], g_bus_voltage_all[0][1]);
SOC_Printf("N5_1: %0.2f A, %0.2f V\r\n", g_shunt_current_all[0][2], g_bus_voltage_all[0][2]);
SOC_Printf("N5_2: %0.2f A, %0.2f V\r\n", g_shunt_current_all[1][0], g_bus_voltage_all[1][0]);
SOC_Printf("E5: %0.2f A, %0.2f V\r\n", g_shunt_current_all[1][1], g_bus_voltage_all[1][1]);
SOC_Printf("P5: %0.2f A, %0.2f V\r\n", g_shunt_current_all[1][2], g_bus_voltage_all[1][2]);
SOC_Printf("L24: %0.2f A, %0.2f V\r\n", g_shunt_current_all[2][0], g_bus_voltage_all[2][0]);
SOC_Printf("8_12: %0.2f A, %0.2f V\r\n", g_shunt_current_all[2][1], g_bus_voltage_all[2][1]);
SOC_Printf("M12: %0.2f A, %0.2f V\r\n", g_shunt_current_all[2][2], g_bus_voltage_all[2][2]);
SOC_Printf("S3V3: %0.2f V\r\n", g_adc_voltage_all[0]);
SOC_Printf("S1V8: %0.2f V\r\n", g_adc_voltage_all[1]);
SOC_Printf("S3V3: %0.2f V\r\n", g_adc_voltage_all[2]);
SOC_Printf("S1V8: %0.2f V\r\n", g_adc_voltage_all[3]);
SOC_Printf("E3V3: %0.2f V\r\n", g_adc_voltage_all[4]);
SOC_Printf("E1V8: %0.2f V\r\n", g_adc_voltage_all[5]);
SOC_Printf("E1V5: %0.2f V\r\n", g_adc_voltage_all[6]);
SOC_Printf("E1V1: %0.2f V\r\n", g_adc_voltage_all[7]);
SOC_Printf("E0V88: %0.2f V\r\n", g_adc_voltage_all[8]);
SOC_Printf("E1V2: %0.2f V\r\n", g_adc_voltage_all[9]);
SOC_Printf("5G3V8: %0.2f V\r\n", g_adc_voltage_all[10]);
SOC_Printf("P1V8: %0.2f V\r\n", g_adc_voltage_all[11]);
SOC_Printf("P3V3: %0.2f V\r\n", g_adc_voltage_all[12]);
SOC_Printf("L3V3: %0.2f V\r\n", g_adc_voltage_all[13]);
SOC_Printf("N16: %0.2f V\r\n", g_adc_voltage_all[14]);
SOC_Printf("N27: %0.2f V\r\n", g_adc_voltage_all[15]);
SOC_Printf("N38: %0.2f V\r\n!!", g_adc_voltage_all[16]);
```

#### UART数据接收完成立即清空FIFO缓存

当前TZ实现方案中，UART接收数据的方案使用的是例程中的中断方案，而非ringBuffer方案，所以尝试增加Cy_SCB_UART_StartRingBuffer以调整ringBuffer缓存区大小的想法测试失败，原因在于未按照实际例子去阻塞运行。了解到本身应用为中断方案之后，可以在接收数据完成之后立即清除当前FIFO中的数据，如此每次接收道德数据互相之间没有干扰，始终能够保证接收到的每一帧数据都是从指定帧头开始，重复测试下来未遇到错序情况（实际上存储时应该同时用到了ringBuffer和FIFO，但是优先存在FIFO中）。故而新的解决方案可以取代重排策略。

#### 进入OTA升级模式后启动计时，超时后退出恢复业务核运行

完成定时器中断的移植，但调测发现周期设置修改不生效，暂不能确定是何处出错，待定位。此外，退出OTA模式后只是重新使能cm7_0和cm7_1核好像并不能启动业务代码，需要进一步定位。

### 2024.8.13

#### UART数据持续稳定收发

系统启动后，状态监控数据总能稳定发送一段时间，而发送数据长度不同时，开始出现乱码并停发数据的时间也不太一样，所以怀疑是资源紧张导致的UART通信阻塞（暂未定位到根本原因）。通过查看源码发现，负责发送UART数据的`UART_SendData`实际上调用的是`Cy_SCB_UART_Transmit`，而`Cy_SCB_UART_Transmit`更适用于发送单字节数据的场景，在持续发送如此大量的数据时可能会出现一些非预期问题。

另一方面，Cypress提供了一个更适合大量数据发送场景的接口`Cy_SCB_UART_PutArray`，相比于前者，它能减少中断的处理次数和上下文切换的开销，提高发送稳定性。

解决方法：更换接口：`Cy_SCB_UART_Transmit` -> `Cy_SCB_UART_PutArray`。

![](https://s2.loli.net/2024/08/13/8X1EZaTCFIHnpym.png)

更换接口后，持续测试发送稳定性（截图数据显示业务核已运行5728 * 10s ≈ 15.9h）。

#### 梳理OTA安全升级策略

梳理当前OTA的升级流程和一些已有的安全策略，整理了文档 OTA安全升级策略.md ，讨论如何保证稳定可靠的升级。

### 2024.8.12

#### 检视TZ提供的精简版代码

对比发现精简的方式是删除每个核编译构建时产生的中间产物（主要是Obj目录下的文件，以cm7_0核为例，Obj目录所占内存高达1.1GB），参照该方法，上传仓库时可以将Exe、List和Obj目录下的全部产物都删除，包括不必要的旧版本，比如rev_b。

![](https://s2.loli.net/2024/08/12/A9BC8VDWSpZc63I.png)

#### 发现Bug：UART数据发一段时间后会卡乱码并停发

MCU通过UART_SendData向SOC发送数据持续一段时间之后，SOC串口中会收到一段乱码，之后就不会再显示新的UART数据（跑在SOC上的ros服务也不能收到），但是此时由SOC向MCU发送下电指令（SOC并未断过电），MCU是能接收并处理的（MCU没死，业务程序还在跑），怀疑是UART_SendData接口有问题：
1、163的设备是以10s为周期，持续向SOC发送长度为1000的字符串；
2、141的设备是以10s为周期，持续向SOC发送长度为700的字符串。

![](https://s2.loli.net/2024/08/12/R79OqvLDBEKCrGV.png)

------

## 周报：2024.8.5~8.9

本周重点进展、问题及风险:

1、调试TZ提供的新版OTA代码，主要涉及OTA架构的更新，为方便后续维护，已将cm0核上A、B分区的源码合并到同一个文件中维护，修改后验证OTA对区刷写成功；

2、针对UART命令偶现错序的问题，原本认为UART中断接收和周期读取为异步操作，但实际上UART中断触发依赖于读取，即原本接收读取的逻辑已是同步处理。在此种情况下，暂无更好的解决方案，幸而通过数据预识别的重排策略（对错序的数据按“帧头-payload-帧尾顺序排列），重复验证能够稳定解决数据错序的问题，故而考虑暂且采用现有方案；

3、在A样裸板MCU和SOC间只有单条UART通道的硬件环境下，测试同时进行OTA版本刷写与调试log回显任务，实测发现SOC侧可能是因为负载过高等问题导致刷写失败和log数据丢失（本质上刷写失败也是丢数据所致）。该问题会直接影响到A样整机（137、141）远程刷写的成功率，当前硬件版本无法解决，只能在B样硬件增加UART资源后才能解决；

4、MCU最新软件版本支持读取全部17路ADC电压、9路INA3221电压电流以及当前软件版本和运行分区号，并以10秒为周期持续上报给SOC。

下周工作计划:

1、针对TZ提供的最新精简源码，识别差异并更新MCU_BSP仓库；

2、针对TZ即将提供MCU支持GPIO心跳的工程源码，识别更新并验证功能；

3、由于当前MCU工程源码并未使用freertos，出于性能需求和可维护性考虑，尝试对现有工程做移植适配，初期将以源码优化开始着手。

### 2024.8.9

#### 支持输上报版本号及运行分区信息

增加当前版本和分区信息以10秒周期上报给SOC；增加读取17路ADC电压以10秒周期上报给SOC：涉及到BSP配置修改和ADC模块源码增改；增加调试相关log上报给SOC；增加5s定时器任务；整理ADC、INA3221、UART、定时器以及cm0和cm7_0核源码排版格式，删除不必要的宏定义、变量及函数声明和定义。

### 2024.8.8

#### 读取全部ADC用电状态

通过与TZ的开发人员沟通获悉，当前交付的IAR工程源码版本中，需要增改配置方可使用，包括在cm7_0核增加包含ADC的头文件和源码、修改cpress-traveo_ii-bsp_freertos/tviibh8m/hdr/rev_c/bb_bsp_tviibh8m.h中有关ADC中断源的配置，增改完成后能够正常调度接口并打印ADC原始数据，验证完成，可以开发。

### 2024.8.7

#### UART单通道OTA刷写与调试log回显测试

在A样裸板MCU和SOC间只有单条UART通道的硬件环境下，测试同时进行OTA版本刷写与调试log回显任务，实测发现SOC侧可能是因为负载过高等问题导致刷写失败和log数据丢失（本质上刷写失败也是丢数据所致）。因为OTA刷写和log回显都是必要功能，所以新版硬件中不得不增加至两路UART，按7.29日会议结论，应当考虑扩展新的UART资源。此外，完成137、141整机MCU版本升级。

#### 读取全部ADC用电状态

当前接口尚未开发完成，可按照例程尝试读取。

### 2024.8.6

#### UART异步读取解析更改适配同步策略

原本认为UART中断接收和读取为异步操作，多次调试后发现，实际上UART中断触发依赖于读取，或者说，在调用读取函数Cy_SCB_UART_Receive之后才会触发中断Cy_SCB_UART_Interrupt，由此可认为原本接收读取的逻辑已是同步处理。
但测试下来，多次发送后UART命令出现错序的问题依然存在，但全部能够通过重排策略解决，暂且使用现有方案，后续再考虑修复该问题。

cm0核上A、B分区的源码合并到同一个文件后，验证对区升级刷写成功。

### 2024.8.5

#### 调试TZ提供的新版OTA代码

比较了新版本的更新内容，主要涉及OTA架构的更新；调试过程中尝试将cm0核上A、B分区的源码合并到同一个文件中维护，其中因为启动时序的问题，当前不得不同时维护多处宏定义，后续可视需要修复。

------

## 周报：2024.7.29~8.2

本周重点进展、问题及风险:

1、评审讨论了当前OTA版本可能存在的问题和改进建议，基本确定了优化方案；

2、开发完成了一体机MCU电源状态监控的初版方案，并简单验证通过；

3、在与ROS服务通信联调过程中，定位发现MCU收到UART命令后会回显相应命令，不利于服务接收端解析，修改相应代码后问题解决；

4、SOC模拟UART命令发给MCU时，概率性出现命令错序的问题，根本原因在于MCU接收和读取命令是异步处理，数据读取可能不完整，针对该问题，在命令解析之前增加了重排策略，保证被解析数据的格式正确，实测能够解决现有问题。

下周工作计划:

1、针对UART命令概率性错序的问题，考虑修改为同步接收和读取的方案；

2、基于天准提供的新版本OTA架构，完成现有业务代码的移植和适配，保证稳定的初版软件。

### 2024.8.2

#### 针对错序的UART命令增加重排策略

经过排查分析，UART命令出现错序的情况多半是因为，中断接收到数据后还未完全写入完成，异步读取缓存的Cy_SCB_UART_Receive就将不完整的数据写进了g_uart8_in_data，从而导致部分数据未被读到，而g_uart8_in_data这边由于长度不足导致该帧命令不处理（无响应），等到下一帧数据接收后，Cy_SCB_UART_Receive仍然只读取环形缓冲区中的前18位，其中就包括上次未读完的部分，进而导致读到的命令顺序错乱。
基于以上分析，连续两帧命令之间，出错未读到的位置是随机的，但因为稳定连续读取18位，所以一次读取的数据中总是包含了顺序正确的两段子串，将两段子串更换顺序之后重新组合即可得到正确的命令。此即重排策略。

#### 异步读取不稳定，需要更改为同步执行

UART命令概率性错序的根因还在于异步读取，需要更改为同步执行，中断触发写入数据后立即读取，或者周期读取之前增加标志判断中断写入完成。

### 2024.8.1

#### UART接收数据后回显给SOC

检视代码发现，UART数据接收完成后，立即通过Cy_SCB_UART_Transmit将数据回传SOC，但是在SOC上通过minicom却没有接收到相应的log，这是因为串口的端口与SOC预设的端口（/dev/ttysWK3）不匹配，重新在minicom上测试发现确实有回显。

![](https://s2.loli.net/2024/08/02/aS6hUAPw1GvkFEt.png)

#### UART接收数据的处理逻辑

代码里接收到数据后会触发中断，数据先被缓存到g_stc_uart8_context的环形缓冲区内，然后在receive_data调用时拷贝到g_uart8_in_data，我现在已经将receive_data的调度周期改为100ms了，g_stc_uart8_context应该是没设定缓存上限的，不会爆缓存，难道是g_stc_uart8_contex的缓存太小了吗？

### 2024.7.31

整理BeyondCompare3激活文档；

整理SOC命令行配置系统网络环境及查询硬盘信息；

整理IAR工程中UART传输收发策略和唤醒缓冲区的理解；

MCU重复接收UART指令会出现“中断不能立即触发”的问题，但并未影响指令时序（需要考虑是否为串口助手的问题还是代码bug），在与ros环境联调时出现“概率性收不到指令->进不了中断->指令错位的问题”，需要进一步定位。

### 2024.7.30

#### 一体机MCU电源状态监控：初版方案开发完成

在此前能够获取INA3221寄存器原始值并输出给Orin的方案基础上，增加了从寄存器原始值到实际电流电压值的转换处理，并简单验证通过。

#### 总结梳理IAR工程调试配置文件缺失定位记录

恢复必要的ewd文件，调整cm7_1核的软件版本为rev_c，确保未出现单核构建同时输出多个软件版本的情况。

### 2024.7.29

初步确定了影响IAR工程调试相关的文件集合：ewd文件以及cm7_1.revc相关的生成文件（设置项目默认版本为rev_c并添加UART路径头文件引用）；

组织评审讨论了当前OTA版本可能存在的问题和改进建议，基本确定了优化方案。

## 周报：2024.7.22~26

本周重点进展、问题及风险:

1、更新MCU的BSP仓库并创建IAR工程的最小集合，同步更新了一体机复位、OTA功能的测试方案；

2、完成一体机毫米波雷达、摄像头单控上下电以及电源状态监控的源码编写和测试，并在与ROS服务的联调测试中验证成功；

3、在多次使用OTA软件升级一体机裸机和样机失败导致MCU挂死无法上电的过程中，熟悉了升级脚本和I-Jet烧录器的使用，同时发起了I-Jet烧录器的采购申请；

4、粗略总结了当前MCU OTA升级版本实现上的不足，已反馈给天准的开发责任人。

下周工作计划:

1、MCU将电源状态通过UART上送给SOC的通道已打通，但是上送的信息还需要梳理明确和格式化解析；

2、Orin单控下电和上电被当做两条指令实现，但是Orin下电之后无法再监听MCU上电的命令，该设计存在漏洞，需要修复；

3、引导并配合天准的OTA开发责任人优化当前MCU OTA版本的已知问题。

### 2024.7.26

#### OTA非预期问题汇总

- 整机上电启动后无法主动进入业务核，而是维持在OTA模式，需要手动切换，不符合用户直觉；
- 上电逻辑同时分布在主核和业务核，而不是集中在单核内，导致OTA升级时需要频繁下电重启；
- UART指令发送时概率性错位导致接收端不识别，导致整机不能下电，存在功能安全风险；
- Orin单控下电和上电被当做两条指令实现，但是Orin下电之后无法再监听上电的命令了；

#### MCU与ROS远程上下电及电源状态监控功能联调验证成功

MCU_BSP库上版本因删除了部分依赖文件，无法直接使用烧录器调试，待定位。

### 2024.7.25

上午修改了三版业务软件并单刷进cm7_0核之后，验证未出现问题，但是第四次刷写后切换分区时，板子挂掉。

> 因为一旦启动刷写cm7_0核，OTA程序就会将cm7_1核一起擦除，所以怀疑是因为未刷写导致板子挂掉（后续每次刷写都要将两个核同时刷写）

完成代码验证和上传：

- **超声波雷达和摄像头单控下电复位**
- **MCU电压状态监控**

> 此前一直未能在MCU的串口助手界面显示监控log，今天定位发现是因为MCU通过UART发送给SOC的数据是在SOC一侧的串口显示，可以通过minicom输出。
>
> 注意：
> Orin的Debug口和minicom串口不是一回事，前者主要用于输出系统日志，可用于定位板子不能唤醒之类的问题。

### 2024.7.24

#### 更新已知内容

1、A分区里烧B_ORIN，B分区里烧A_ORIN，cm0核所用代码版本在A、B分区并不一样（这也是今天双区烧板之后再切分区就挂死的根本原因）；

2、MCU只能在单核运行的情况下切换分区，这种情况下是能自动起来；

3、多核情况下，MCU芯片限制无法切换分区，所以实现上是先重启进入OTA单核模式才能切换分区；

4、多核场景下只能在flash里跑，不是在ram里跑，所以flash切换后需要重新上下电执行对应分区的代码；

5、Orin启动后40秒内会扫描所有下挂硬件，如果未检测到或超时后插入，Orin不能识别对应硬件。

#### 新问题与新方向

1、将Orin_power_on执行时序提前，比如在切换分区之前，是否能不必重复上下电？

2、MCU通过OTA升级失败后版本回退，保证整机正确运行；

3、MCU控制硬件上下电，但是要缩小影响范围，保证功能安全（不能通过GPIO控制供电，否则MCU下电必然导致其他硬件全部下电）；

4、Orin接收不到其他硬件的指令后，需要重新发送升级指令，直接自行对MCU做OTA升级刷写，确保系统正常运行。

### 2024.7.23

#### 编码

编写毫米波雷达、摄像头单控上下电的控制源码，进一步编译构建得到可执行应用文件，等待测试环境升级验证。

#### 总结

输出 **Ubuntu中VSCode配置C环境** 和 **VSCode快捷键** ，以及 **IAR构建烧录全流程** ；
并与天准确认：OTA升级脚本支持cm0主核升级。

### 2024.7.22

更新MCU的BSP仓库，尝试创建IAR工程的最小集合，移除不必追踪的中间文件。
验证发现flash/settings下的配置文件为必要项，直接执行tools/iar/cleanup.bat删除整个文件夹会导致编译失败。

同步一体机复位测试方案。

------

## 周报：2024.7.15~19

本周重点进展、问题及风险:

1、熟悉MCU OTA版本IAR工程源码，并基于OTA版本代码进行上下电功能的简单测试，结果出现了整机无法启动的问题。最终会同天准同事定位得出初步结论：复现过程中连续出现过两次整机不能启动的情况，反复尝试、重新完整烧录之后，问题暂未复现，但发现新问题：在切分区之后进行整机下电时，SOC不能主动上电，需要手动拔插电源解决（该Bug已由天准认领待后续解决）。

2、对照MCU porting guide和IAR工程源码，基本确定毫米波雷达和相机单控的方案。

3、学习ROS2话题与服务、参数与动作以及常用工具相关的基础知识。

下周工作计划:

1、基于MCU OTA版本完成相机、毫米波雷达的单控上下电控制功能的进一步开发。

2、设计开发一体机MCU电源状态通过UART实现信息上报。

### 2024.7.19

#### 熟悉MCU OTA版本IAR工程源码

在cm0核新增了OTA升级功能；

将原有的cm0核上上下电控制功能迁移到cm7_0核，并新增了Orin上下电、Nano上下电的功能。

#### MCU OTA版本代码上下电功能简单测试

在141整机上尝试执行了整机下电动作，整机顺利下电但无法正常恢复上电，累计测试6次，3次成功3次失败，其中失败的场景中，

（1）一次在于原始烧录的程序直接进行整机上下电测试时，顺利退出OTA模式，整机下电后不能重启，拔插电源也不能解决；
（2）另一次在于从B区切换到A区后，需要重新插拔电源再执行“退出OTA模式”动作——卡住不能启动；
（3）还有一次在于从A区切换到B区后，需要重新插拔电源再执行“退出OTA模式”动作——卡住不能启动；

最终定位结论是：重新完整烧录之后，问题未复现，但发现在切分区之后整机下电但是SOC不能主动上电，需要手动拔插电源解决（该Bug已由天准认领待后续解决）。

### 2024.7.18

#### 一体机MCU电源状态监控

目前版本中提供了

```c
tztek_ina3221_GETShuntVoltage_ALL();
tztek_ina3221_GETBusVoltage_ALL();
```

可以用来读取INA3221电源监控芯片中的原始值，乘以系数40uv即为真实电压值，可通过以下代码转换

```c
int16_t raw_value = (rx_data[0] << 8) | rx_data[1];
float shunt_voltage = raw_value * 40.0e-6; // 转换为伏特
printf("Shunt Voltage: %.6f V\n", shunt_voltage);
```

但目前该接口实现只将电压值打印，未通过UART串口输出。故而需要

1、周期（1s）上送，创建全局变量
2、转换输出并格式化
3、通过`void UART_SendData( uint8_t *data, size_t size)`将格式化信息输出到串口，供orin接收

> 实现细节可以参考温湿度的周期上报
>
> ```c
> // 没有下电请求，执行其他周期性任务
> tztek_aht2415c_GET_ALL();
> 
> // 格式化要发送的数据字符串
> char data_string[50];
> snprintf(data_string, sizeof(data_string), "RH: %0.2f %% T: %0.2f °C\r\n", g_humidity, g_temperature);
> 
> // 发送数据到串口
> UART_SendData((uint8_t*)data_string, strlen(data_string));
> ```

#### 一体机上下电单控毫米波雷达

查询[MCU porting guide](/home/tyjt/Downloads/Documents/MCU_porting guide_CYT4BF.xlsx)可以发现，毫米波12V供电使能PIN脚为MCU上P2.7

![](https://s2.loli.net/2024/07/18/WVtEJazchuj3pI7.png)

查看IAR源码了解，系统上下电过程中会主动使能、清除该引脚状态，从而控制毫米波雷达的供电

```c
// 上电置位
Cy_GPIO_Set(USER_MM12V_PORT, USER_MM12V_PIN);
// 下电清空
Cy_GPIO_Clr(USER_MM12V_PORT, USER_MM12V_PIN);

// 引脚定义
#define USER_MM12V_PORT                    USER_MM12V_PORT1

#define USER_MM12V_PORT1                    GPIO_PRT2
#define USER_MM12V_PIN1                     7
#define USER_MM12V_PIN_MUX1                 P2_7_GPIO
```

因为毫米波雷达上下电不受时序影响，由此可以定义一个控制毫米波雷达下电重启的简易函数

```c
void mm_wave_radar_power_reset(void)
{
	// 下电清空
    Cy_GPIO_Clr(USER_MM12V_PORT, USER_MM12V_PIN);
    // 等待0.1s
    Cy_SysTick_DelayInUs(100000ul);
    // 上电置位
    Cy_GPIO_Set(USER_MM12V_PORT, USER_MM12V_PIN);
}
```

该函数可以在`void processMessage(int msg)`中直接在某个case下调用处理。

#### 一体机上下电单控相机

与毫米波雷达相似，查到相机12V供电使能PIN脚为MCU上P2.6

```c
// 上电置位
Cy_GPIO_Set(USER_CAM12V_PORT, USER_CAM12V_PIN);
// 下电清空
Cy_GPIO_Clr(USER_CAM12V_PORT, USER_CAM12V_PIN);

// 引脚定义
#define USER_CAM12V_PORT                    USER_CAM12V_PORT1

#define USER_CAM12V_PORT1                    GPIO_PRT2
#define USER_CAM12V_PIN1                     6
#define USER_CAM12V_PIN_MUX1                 P2_6_GPIO
```

因为相机上下电不受时序影响，由此可以定义一个控制相机下电重启的简易函数

```c
void camera_power_reset(void)
{
	// 下电清空
	Cy_GPIO_Clr(USER_CAM12V_PORT, USER_CAM12V_PIN);
    // 等待0.1s
    Cy_SysTick_DelayInUs(100000ul);
    // 上电置位
	Cy_GPIO_Set(USER_CAM12V_PORT, USER_CAM12V_PIN);
}
```

该函数可以在`void processMessage(int msg)`中直接在某个case下调用处理。

### 2024.7.17

完成《动手学ROS》入门篇第5章关于ROS2常用工具的学习、实操和总结；

同时学习了解了ROS2硬件控制篇。

### 2024.7.16

完成《动手学ROS》入门篇第4章关于ROS2通信之参数与动作的学习、实操和总结；

经过与天准同事沟通确认，MCU通过INA3221电源监控芯片实时监控MCU供电状态，可以调用接口`tztek_ina3221_GETShuntVoltage_ALL`和`tztek_ina3221_GETBusVoltage_ALL`获取并打印各路电压。

### 2024.7.15

完成《动手学ROS》入门篇第3章关于ROS2节点通信之话题与服务的学习、实操和总结。

------

## 周报：2024.7.8~12

本周重点进展、问题及风险:

1、梳理一体机工程源码，理清了MCU从接收Orin下发的UART上下电指令到完成复位的控制逻辑，并实测验证通过；但是发现一个潜在Bug：程序在处理接收到的UART指令时，只会在顺次发送每满14个字符时做一次匹配，一旦输入顺序错乱，就很难再输对正确指令完成复位控制（该Bug可以通过脚本或者串口助手保证正确输入顺序的方式得以规避）。

2、安装ROS2开发环境，学习ROS2节点通信基础知识。

下周工作计划:

1、一体机远程监控/上下电控制功能的进一步开发。

2、继续学习ROS2。

本周工作其他细节及思考:

查漏补缺，及时总结。

------

## 周报：2024.7.1~5

本周工作内容:

1、参加入职培训，学习项目背景和企业文化；

2、学习新手教程，申请账号并搭建开发环境；

3、学习天准提供的一体机工程源码，为MCU控制任务做准备。

下周工作计划:

在继续熟悉一体机工程源码有关上下电逻辑的基础上，按时完成远程控制一体机上下电的任务计划。